<%- include('partials/Statics/Head', {page: '- Messages'}) %>
<body>
    <main class="page-wrapper messages-view">
<!-- Fix the Scolling when a lot of conversation are active and when you are in a long conversation -->
<!-- Make it that the section always take all the screen no matter how much active conversation there are -->
    <%- include('partials/Statics/Navbar') %>

    <section>
      <div class="row">
        <div>
          <input type="checkbox" id="change-messages" hidden/>
          <div class="messages-container">
            <div class="contacts">
              <div class="messages-heading"> <h1 class="h3 mb-0 px-4 py-3">Messages </h1>
                <label for="change-messages"><%- include ("../public/assets/img/icons/close-cross.svg") %></label>
              </div>
               <form class="search-messages px-4" action="/search-messages" method="POST">
                <div>
                  <button type="submit">
                      <i class="bx bx-search-alt fs-xl text-light"></i> 
                  </button>
                </div>
             
                <input type="search" name="search" maxlength="100" placeholder="Search" required>
                <input type="submit" hidden/>
              </form>
              <div class="contact-list">
                <% for(let i = conversations.length - 1; i >= 0; i--) { %>
                  <% const otherUser = authuser.id === conversations[i].users[0].user.id ? 1 : 0 %> 

                  <% if (conversations[i].id === selectedConversation.id) { %>
                    <label for="change-messages">
                      <a href="/messages?id=<%= conversations[i].id %>#bottom" class="selected-convo position-relative d-flex align-items-start text-decoration-none pe-none py-3 px-4">
                        <div class="position-absolute top-0 start-0 bg-primary w-3 h-100"></div>
                        <img src="<%= conversations[i].users[otherUser].user.img_path %>" class="smedium-rc rounded-circle" alt="<%= conversations[i].users[otherUser].user.username %>">
                       
                        <div class="ps-2 ms-1">
                          <div class="mb-1">
                            <h6 class="mb-0 me-2"><%= conversations[i].users[otherUser].user.username %></h6>
                          </div>
                            <p class="convo-snippet fs-sm text-body mb-0">
                              <%= conversations[i].messages[conversations[i].messages.length - 1].content %>
                          </p>
                        </div>
                      </a>
                    </label>
                  
                  <% } else { %>
                    <a href="/messages?id=<%= conversations[i].id %>#bottom" class="d-flex align-items-start text-decoration-none bg-faded-primary-hover py-3 px-4">
                      <img src="<%= conversations[i].users[otherUser].user.img_path %>" class="smedium-rc rounded-circle" alt="<%= conversations[i].users[otherUser].user.username %>">
                     
                      <div class="ps-2 ms-1">
                        <div class="mb-1">
                          <h6 class="mb-0 me-2"><%= conversations[i].users[otherUser].user.username %></h6>
                        </div>
                          <p class="convo-snippet fs-sm text-body mb-0">
                            <%= conversations[i].messages[conversations[i].messages.length - 1].content %>
                        </p>
                      </div>
                    </a>
                  <% } %>
                  <div class="contact-divider"></div>
                <% } %>
              </div>
            </div>
            <div class="chat">
              <div class="chat-body">

                <% if (!selectedConversation) { %>
                  <div class="no-convo-yet">
                    <h6>No Conversation Yet</h6>
                  </div>
                <% } else { %> 
                <input id="delete-convo-input" type="checkbox" hidden></input>
                <%- include('partials/Popup/Delete-popup', {checkboxInputId:"delete-convo-input", action : "/delete-conversation/" + selectedConversation.id + "?_method=DELETE", method: "POST", text: "conversation", confirm_text: "Delete", cancel_text: "Cancel"}) %>
                <input id="user-pgp-keys" type="checkbox" hidden></input>
                <%- include('partials/Popup/PgpKeys-popup', {checkboxInputId:"user-pgp-keys", text: selectedConversation.sender2_Pgp, cancel_text: "No"}) %>

                <!-- Header -->
                <% const otherUser = authuser.id === selectedConversation.users[0].user.id ? 1 : 0 %>

                <div class="messages-header px-3">
                    <div class="change-convo me-2">
                        <label for="change-messages">
                            <%- include ("../public/assets/img/icons/caret-down.svg") %>
                            <%- include ("../public/assets/img/icons/change-person.svg") %>
                        </label>
                    </div>
                    <div class="chat-user">
                        <a href="/profile/<%=selectedConversation.users[otherUser].user.username%>?productPage=1&reviewPage=1" class="mb-0 mx-0">
                            <img src="<%=selectedConversation.users[otherUser].user.img_path%>" class="medium-rc rounded-circle" width="40" alt="<%=selectedConversation.users[otherUser].user.username%>">
                        </a>
                        <div class="name-and-type">
                            <a href="/profile/<%=selectedConversation.users[otherUser].user.username%>?productPage=1&reviewPage=1" class="mb-0 mx-0"><%= selectedConversation.users[otherUser].user.username %></a>
                            <div>
                                <p class="fs-sm opacity-70 m-0"><span>Type of Conversaction:
                                    </span>selectedConversation.settings.type</p>
                            </div>
                        </div>
                        <!-- <div class="bg-success rounded-circle" style="width: 8px; height: 8px;"></div> -->
                    </div>
                    <div class="delete-button-container">
                        <label for="user-pgp-keys" class="btn btn-outline-white me-3 user-pgp-keys">
                            <i class='bx bxs-key fs-xl me-xl-2'></i>
                            <span class="d-none d-xl-inline">Pgp Keys</span>
                        </label>
                        <label for="delete-convo-input" class="btn btn-outline-danger">
                            <i class="bx bx-trash-alt fs-xl me-xl-2"></i>
                            <span class="d-none d-xl-inline">Delete Conversation</span>
                        </label>
                    </div>
                </div>
                <!-- Messages -->
                <div class="messages-main px-3">
                    <% for(let i = 0; i < selectedConversation.messages.length ; i++) {%>

                    <div>
                        <% if (selectedConversation.users[selectedConversation.messages[i].sender].user.id === authuser.id) { %>
                        <!-- Own message -->
                        <div
                            class="message-entry message-entry--own <%- (i + 1 === selectedConversation.messages.length && selectedConversation.messages[i].messageView)?'pb-4':'ee' %>">
                            <div class="position-relative py-2 px-3">
                                <div class="message-text" style="
                                        border-top-left-radius: 0.5rem;
                                        border-bottom-right-radius: 0.5rem;
                                        border-bottom-left-radius: 0.5rem;
                                    ">
                                    <span><%= selectedConversation.messages[i].content%></span>
                                    <input id="delete-message-input-<%=i%>" type="checkbox" hidden></input> <!-- when checked css shows next element -->
                                    <%- include('partials/Popup/Delete-popup', {checkboxInputId:"delete-message-input-"+ i, action : "/delete-message/" +  selectedConversation.id + "/" + selectedConversation.messages[i].id + "?_method=DELETE", method: "POST", text: "message", confirm_text: "Delete", cancel_text: "Cancel"}) %>
                                
                                    <input id="edit-message-input-<%=i%>" type="checkbox" hidden></input> <!-- when checked css shows next element -->
                                    <%- include('partials/Popup/EditMessage-popup', {checkboxInputId:"edit-message-input-"+ i, action : "/edit-message/" +  selectedConversation.id + "/" + selectedConversation.messages[i].id, currentMessage: selectedConversation.messages[i].content}) %>
                                    
                                    <label for="delete-message-input-<%=i%>" class="delete-message-button btn">
                                        <i class="bx bx-trash-alt"></i>
                                    </label>
                                    
                                    <!--  if (selectedConversation.editButton.includes(i)) { 
                                        <label for="edit-message-input-<%=i%>" class="delete-message-button b-edit btn me-4">
                                            <i class='bx bxs-edit' style="color:black;"></i>
                
                                        </label>
                                     -->
                                </div>
                                <% if (i + 1 === selectedConversation.messages.length && selectedConversation.messages[i].messageView){ %>
                                <!-- Read Template, you cant put the code at differrent place if it is easier -->
                                <!-- <div class="d-flex">  -->
                                <p class="position-absolute fs-sm text-primary m-0" style="left: 0px;bottom: -25px">
                                    <%- include ("../../public/assets/img/icons/check-double.svg") %>
                                    Read
                                </p>
                                <!-- </div> -->
                                <% } %>
                            </div>
                        </div>
                        <% } else { %>
                        <!-- User message -->
                        <div
                            class="message-entry <%- (i + 1 === selectedConversation.messages.length && selectedConversation.messages[i].messageView)?'pb-4':'ee' %>">
                            <% if (i === 0 || i > 0 && selectedConversation.messages[i - 1].sender !== selectedConversation.messages[i].sender) { %>
                            <img src="<%=selectedConversation.users[otherUser].user.img_path%>" class="smedium-rc rounded-circle" width="40" alt="<%=selectedConversation.users[otherUser].user.username%>"/>
                            <div class="position-relative d-flex align-items-center py-2 px-3 ms-2">
                            <% } else { %> 
                                <div class="position-relative py-2 px-3" style="margin-left: 3.5rem;">
                            <% } %>
                                    <div>
                                        <div>
                                            <div class="message-text" style="
                                            border-top-right-radius: 0.5rem;
                                            border-bottom-right-radius: 0.5rem;
                                            border-bottom-left-radius: 0.5rem;
                                        ">
                                                <span><%= selectedConversation.messages[i].content %></span>
                                            </div>
                                        </div>
                                    </div>
                                    <% if (i + 1 === selectedConversation.messages.length && selectedConversation.messages[i].messageView){ %>
                                    <!-- Read Template -->
                                    <!--you cant put the code at differrent place if it is easier-->
                                    <!-- <div class="ms-5">  -->
                                    <p class="fs-sm text-primary ms-1 position-absolute m-0" style="right: 0px;bottom: -25px;">
                                        <%- include ("../../public/assets/img/icons/check-double.svg") %>
                                        Read
                                    </p>
                                    <!-- </div> -->
                                    <% } %>
                                </div>
                            </div>
                            <% } %>
                        </div>
                        <% } %>


                        <!-- For loop End -->
                        <div id="bottom" class="swiper-scrollbar end-0"></div>
                    </div>
            
                    <!-- Footer (Send message form) -->
                    <%- include('partials/Message-send') %>
                </div>
                <% } %>
            </div>

            </div>
          </div>
        </div>
      
      </div>
    </section>
    </html>